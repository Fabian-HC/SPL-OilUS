# Install packages if not installed
libraries = c("plyr","dplyr","data.table")
lapply(libraries, function(x) if (!(x %in% installed.packages())) {
  install.packages(x)
})

# Load packages
lapply(libraries, library, quietly = TRUE, character.only = TRUE)


# Define required functions

logreturnsfun = function(x){
  n = length(x)
  logreturn = diff(log(x), lag=1)
  # AS numeric part added
}

firstdiffun = function(x){
  n = length(x)
  firstdif = diff(x, lag=1)
}

setwd("/Users/antton/Desktop/Statistique programming")
data <- read.csv2("Dataset-FINALupdated_absolute.csv", stringsAsFactors=FALSE)

# Convert Date such that R recognizes it as date
class(data$Date)
data$Date <- as.Date(data$Date, format = "%d.%m.%Y")
class(data$Date)

#Change data order to us Logreturns
datat = data[order(data$Company,data$Date),]

#logreturn#
LogR = apply (
  X = datat[,c(3, 4, 6, 8:11)], 
  MARGIN = 2 , 
  logreturnsfun
)

#first difference
FirstDiff = apply (
  X = datat[,c(5,7)], 
  MARGIN = 2 , 
  firstdiffun
)

#deleting false log return#
Datatrans = data.frame(cbind(datat[2:711,1:2],LogR,FirstDiff))
Datatrans2 = subset(Datatrans, as.Date("1996-06-30")<Datatrans$Date)
#checking wich row have been deleted
anti_join(Datatrans,Datatrans2)
#final changes#
dataFinal = Datatrans2[,c(1:4,10,5,11,6:9)]

# Save the transformed dataset
write.csv2(dataFinal, file = "Z_Transformed_variables_Quarterly_returns_as_Marcus.csv")
